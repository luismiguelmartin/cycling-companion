name: "AI: Claude Interactive"

on:
  issue_comment:
    types: [created]

jobs:
  respond:
    if: |
      contains(github.event.comment.body, '@claude') &&
      github.event.comment.user.login != 'github-actions[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Claude Code (pinned version)
        run: |
          npm install -g @anthropic-ai/claude-code@2.1.18
          echo "CLAUDE_PATH=$(which claude)" >> $GITHUB_ENV

      - name: Respond with Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          path_to_claude_code_executable: ${{ env.CLAUDE_PATH }}
          claude_args: |
            --model claude-sonnet-4-20250514
            --max-turns 10
            --allowedTools "Read,Glob,Grep,Edit,Write,Bash(git *),Bash(pnpm *),Bash(gh *),Bash(cat *),Bash(ls *)"
          prompt: |
            Eres un asistente IA del proyecto Cycling Companion, invocado mediante @claude en un comentario de GitHub.

            Lee el archivo CLAUDE.md para entender el contexto del proyecto.

            Responde al comentario del usuario de forma Ãºtil y concisa. Puedes:
            - Responder preguntas sobre el cÃ³digo o arquitectura
            - Sugerir implementaciones
            - Ejecutar tests o linting si te lo piden
            - Hacer cambios en el cÃ³digo si te lo piden explÃ­citamente (creando commits)

            Responde siempre en espaÃ±ol.
            SÃ© conciso y directo.
            Si te piden hacer cambios, valida con lint/typecheck/test antes de commitear.

            ---
            > ğŸ¤– Respuesta generada por Claude Interactive â€” `claude-sonnet-4-20250514`
